{
  "name": "Atendimento Automatizado - Grupo Thermas",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-thermas",
        "options": {}
      },
      "id": "webhook-whatsapp",
      "name": "Webhook WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// Processar mensagem recebida do Z-API\nconst message = items[0].json;\n\n// Extrair dados importantes\nconst phoneNumber = message.from || message.data?.from;\nconst messageText = message.message || message.data?.message || '';\nconst instanceId = message.instanceId || message.data?.instanceId;\nconst fromName = message.fromName || message.data?.fromName || 'Cliente';\n\n// Normalizar nÃºmero de telefone\nconst cleanPhone = phoneNumber.replace(/\\D/g, '');\nconst formattedPhone = cleanPhone.startsWith('55') ? cleanPhone : '55' + cleanPhone;\n\n// Detectar intenÃ§Ã£o baseada em palavras-chave\nconst messageTextLower = messageText.toLowerCase();\nlet intention = 'general';\nlet priority = 'normal';\n\n// Palavras-chave para diferentes intenÃ§Ãµes\nconst keywords = {\n  pacotes: ['pacote', 'viagem', 'caldas novas', 'thermas', 'resort', 'hospedagem'],\n  precos: ['preÃ§o', 'valor', 'quanto custa', 'orÃ§amento', 'promoÃ§Ã£o'],\n  reserva: ['reservar', 'agendar', 'disponibilidade', 'data', 'quando'],\n  urgente: ['urgente', 'emergÃªncia', 'problema', 'cancelar'],\n  humano: ['atendente', 'humano', 'pessoa', 'falar com alguÃ©m']\n};\n\n// Detectar intenÃ§Ã£o\nfor (const [key, words] of Object.entries(keywords)) {\n  if (words.some(word => messageTextLower.includes(word))) {\n    intention = key;\n    if (key === 'urgente') priority = 'high';\n    break;\n  }\n}\n\n// Verificar se Ã© primeira mensagem do cliente\nconst isFirstContact = !messageText.includes('continuando') && !messageText.includes('obrigad');\n\nreturn [{\n  json: {\n    phoneNumber: formattedPhone,\n    originalPhone: phoneNumber,\n    messageText: messageText,\n    instanceId: instanceId,\n    fromName: fromName,\n    intention: intention,\n    priority: priority,\n    isFirstContact: isFirstContact,\n    timestamp: new Date().toISOString(),\n    processedAt: Date.now()\n  }\n}];"
      },
      "id": "processar-mensagem",
      "name": "Processar Mensagem",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.intention}}",
              "operation": "equal",
              "value2": "humano"
            }
          ]
        }
      },
      "id": "verificar-handoff",
      "name": "Verificar Handoff",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// Gerar resposta automÃ¡tica baseada na intenÃ§Ã£o\nconst data = items[0].json;\nconst intention = data.intention;\nconst fromName = data.fromName;\nconst isFirstContact = data.isFirstContact;\n\nlet response = '';\nlet shouldContinue = true;\n\n// Respostas baseadas na intenÃ§Ã£o\nswitch (intention) {\n  case 'pacotes':\n    response = `ğŸŒŠ OlÃ¡ ${fromName}! Que bom que vocÃª tem interesse nos nossos pacotes para Caldas Novas!\n\nğŸ¨ **PACOTES DISPONÃVEIS:**\nâ€¢ ğŸ’‘ Pacote Casal - A partir de R$ 890\nâ€¢ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Pacote FamÃ­lia - A partir de R$ 1.200  \nâ€¢ ğŸ‘¥ Pacote Grupo - A partir de R$ 750\n\nâœ… **INCLUSOS:**\nâ€¢ Hospedagem em resort 5 estrelas\nâ€¢ CafÃ© da manhÃ£ completo\nâ€¢ Acesso Ã s piscinas termais\nâ€¢ Transfer aeroporto\nâ€¢ RecreaÃ§Ã£o infantil\n\nGostaria de mais detalhes sobre algum pacote especÃ­fico? ğŸ˜Š\n\nDigite:\nâ€¢ \"CASAL\" para pacote romÃ¢ntico\nâ€¢ \"FAMÃLIA\" para pacote familiar\nâ€¢ \"GRUPO\" para pacote em grupo`;\n    break;\n    \n  case 'precos':\n    response = `ğŸ’° **PREÃ‡OS ESPECIAIS GRUPO THERMAS**\n\nğŸ·ï¸ Valores promocionais:\nâ€¢ **Final de semana:** R$ 750/pessoa\nâ€¢ **Semana:** R$ 590/pessoa  \nâ€¢ **PromoÃ§Ã£o Flash:** R$ 490/pessoa\n\nğŸ“‹ **INCLUSO NO PREÃ‡O:**\nâœ… 3 dias / 2 noites\nâœ… Todas as refeiÃ§Ãµes\nâœ… Atividades aquÃ¡ticas\nâœ… RecreaÃ§Ã£o e entretenimento\nâœ… Estacionamento gratuito\n\nğŸ¯ **CONDIÃ‡Ã•ES ESPECIAIS:**\nâ€¢ AtÃ© 12x sem juros\nâ€¢ 10% desconto Ã  vista\nâ€¢ CrianÃ§as atÃ© 6 anos: GRÃTIS\n\nQuer que eu monte um orÃ§amento personalizado? \nMe informe quantas pessoas e as datas! ğŸ“…`;\n    break;\n    \n  case 'reserva':\n    response = `ğŸ“… **FAZER SUA RESERVA Ã‰ FÃCIL!**\n\nPara verificar disponibilidade e fazer sua reserva, preciso de algumas informaÃ§Ãµes:\n\nğŸ‘¥ **Quantas pessoas?**\nğŸ“… **Datas desejadas?**\nğŸ¨ **Tipo de acomodaÃ§Ã£o preferida?**\nğŸ’° **OrÃ§amento aproximado?**\n\nâš¡ **DISPONIBILIDADE EM TEMPO REAL:**\nâ€¢ PrÃ³ximos fins de semana: âœ… DisponÃ­vel\nâ€¢ Feriados: âš ï¸ Limitado\nâ€¢ FÃ©rias escolares: ğŸ”¥ Alta demanda\n\nResponda essas informaÃ§Ãµes e eu verifico tudo para vocÃª em segundos! ğŸš€`;\n    break;\n    \n  case 'urgente':\n    response = `ğŸš¨ **ATENDIMENTO PRIORITÃRIO**\n\nEntendi que Ã© urgente! Vou te conectar com nossa equipe especializada imediatamente.\n\nğŸ“ **CONTATOS DIRETOS:**\nâ€¢ WhatsApp UrgÃªncia: (62) 99999-9999\nâ€¢ Telefone 24h: (62) 3333-3333\n\nâ° Tempo de resposta: **IMEDIATO**\n\nEnquanto isso, me conte o que aconteceu para eu jÃ¡ adiantar sua solicitaÃ§Ã£o:`;\n    shouldContinue = false; // NÃ£o continuar automaÃ§Ã£o, transferir para humano\n    break;\n    \n  case 'humano':\n    response = `ğŸ‘‹ Claro! Vou te conectar com um de nossos atendentes especializados.\n\nâ° **HorÃ¡rio de atendimento humano:**\nâ€¢ Segunda a Sexta: 8h Ã s 18h\nâ€¢ SÃ¡bados: 8h Ã s 14h\nâ€¢ Domingos: 9h Ã s 17h\n\nğŸ• Agora sÃ£o ${new Date().toLocaleTimeString('pt-BR')} - ${new Date().getHours() >= 8 && new Date().getHours() <= 18 ? 'ONLINE' : 'OFFLINE'}\n\n${new Date().getHours() >= 8 && new Date().getHours() <= 18 ? \n  'âœ… Conectando vocÃª com atendente... Aguarde alguns segundos!' :\n  'ğŸŒ™ Fora do horÃ¡rio de atendimento. Deixe sua mensagem que responderemos primeira hora da manhÃ£!'}`;\n    shouldContinue = false;\n    break;\n    \n  default:\n    if (isFirstContact) {\n      response = `ğŸ‘‹ **OlÃ¡ ${fromName}! Bem-vindo ao Grupo Thermas!**\n\nğŸŒŠ Somos especialistas em viagens para **Caldas Novas** com mais de 15 anos de experiÃªncia!\n\nğŸ¯ **COMO POSSO AJUDAR VOCÃŠ HOJE?**\n\nğŸ“± **MENU RÃPIDO:**\nâ€¢ Digite \"PACOTES\" - Ver opÃ§Ãµes de viagem\nâ€¢ Digite \"PREÃ‡OS\" - Consultar valores\nâ€¢ Digite \"RESERVAR\" - Fazer sua reserva\nâ€¢ Digite \"HUMANO\" - Falar com atendente\n\nğŸ† **POR QUE ESCOLHER O GRUPO THERMAS?**\nâœ… Melhor custo-benefÃ­cio da regiÃ£o\nâœ… Atendimento 24/7\nâœ… Mais de 50.000 clientes satisfeitos\nâœ… Parcelamento em atÃ© 12x sem juros\n\nEstou aqui para tornar sua viagem inesquecÃ­vel! ğŸ˜Š`;\n    } else {\n      response = `OlÃ¡ ${fromName}! ğŸ˜Š\n\nNÃ£o entendi muito bem sua mensagem. Pode me explicar melhor como posso ajudar?\n\nğŸ’¡ **DICAS RÃPIDAS:**\nâ€¢ \"PACOTES\" - Ver opÃ§Ãµes de viagem\nâ€¢ \"PREÃ‡OS\" - Consultar valores  \nâ€¢ \"RESERVAR\" - Fazer reserva\nâ€¢ \"HUMANO\" - Falar com atendente\n\nOu me conte em suas palavras o que vocÃª estÃ¡ procurando! ğŸ¯`;\n    }\n}\n\nreturn [{\n  json: {\n    ...data,\n    response: response,\n    shouldContinue: shouldContinue,\n    responseGenerated: true,\n    responseLength: response.length\n  }\n}];"
      },
      "id": "gerar-resposta-ia",
      "name": "Gerar Resposta IA",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "url": "https://api.z-api.io/instances/{{$json.instanceId}}/token/SEU_TOKEN_AQUI/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{$json.phoneNumber}}"
            },
            {
              "name": "message",
              "value": "={{$json.response}}"
            }
          ]
        },
        "options": {}
      },
      "id": "enviar-resposta-zapi",
      "name": "Enviar Resposta Z-API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1120,
        200
      ]
    },
    {
      "parameters": {
        "functionCode": "// Notificar equipe sobre handoff\nconst data = items[0].json;\n\nconst notification = {\n  type: 'handoff_request',\n  customer: {\n    phone: data.phoneNumber,\n    name: data.fromName,\n    lastMessage: data.messageText\n  },\n  urgency: data.priority,\n  timestamp: new Date().toISOString(),\n  reason: data.intention === 'humano' ? 'Cliente solicitou atendente' : 'SituaÃ§Ã£o urgente detectada'\n};\n\nreturn [{\n  json: {\n    ...data,\n    notification: notification,\n    handoffInitiated: true\n  }\n}];"
      },
      "id": "notificar-handoff",
      "name": "Notificar Handoff",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "url": "https://seudominio.com/api/notifications/handoff",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer SEU_TOKEN_SISTEMA"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "notification",
              "value": "={{$json.notification}}"
            }
          ]
        },
        "options": {}
      },
      "id": "enviar-notificacao-sistema",
      "name": "Enviar NotificaÃ§Ã£o Sistema",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1120,
        400
      ]
    },
    {
      "parameters": {
        "url": "https://seudominio.com/api/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer SEU_TOKEN_SISTEMA"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{$json.phoneNumber}}"
            },
            {
              "name": "name",
              "value": "={{$json.fromName}}"
            },
            {
              "name": "source",
              "value": "whatsapp"
            },
            {
              "name": "intention",
              "value": "={{$json.intention}}"
            },
            {
              "name": "firstMessage",
              "value": "={{$json.messageText}}"
            },
            {
              "name": "priority",
              "value": "={{$json.priority}}"
            },
            {
              "name": "createdAt",
              "value": "={{$json.timestamp}}"
            }
          ]
        },
        "options": {}
      },
      "id": "salvar-lead",
      "name": "Salvar Lead no Sistema",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.intention}}",
              "operation": "equal",
              "value2": "pacotes"
            }
          ],
          "boolean": [
            {
              "value1": "={{$json.isFirstContact}}",
              "value2": true
            }
          ]
        },
        "combineOperation": "any"
      },
      "id": "verificar-interesse-comercial",
      "name": "Verificar Interesse Comercial",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1560,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// Agendar follow-up automÃ¡tico\nconst data = items[0].json;\n\n// Agendar para 2 horas se nÃ£o houver resposta\nconst followUpTime = new Date();\nfollowUpTime.setHours(followUpTime.getHours() + 2);\n\n// Agendar para 1 dia se for lead qualificado\nconst longTermFollowUp = new Date();\nlongTermFollowUp.setDate(longTermFollowUp.getDate() + 1);\n\nconst followUpMessage = `ğŸ”” OlÃ¡ ${data.fromName}!\n\nVi que vocÃª teve interesse nos nossos pacotes para Caldas Novas. \n\nğŸ¤” Ficou alguma dÃºvida? Posso ajudar com mais informaÃ§Ãµes?\n\nğŸ’¡ **OFERTA ESPECIAL HOJE:**\nğŸ¯ 15% de desconto para reservas feitas atÃ© Ã s 18h\nâ° VÃ¡lido apenas hoje!\n\nQuer aproveitar? Ã‰ sÃ³ me avisar! ğŸ˜Š`;\n\nreturn [{\n  json: {\n    ...data,\n    followUp: {\n      scheduledFor: followUpTime.toISOString(),\n      longTermScheduledFor: longTermFollowUp.toISOString(),\n      message: followUpMessage,\n      type: 'commercial_follow_up'\n    },\n    followUpScheduled: true\n  }\n}];"
      },
      "id": "agendar-followup",
      "name": "Agendar Follow-up",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1780,
        200
      ]
    },
    {
      "parameters": {
        "url": "https://seudominio.com/api/followup/schedule",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer SEU_TOKEN_SISTEMA"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "followUp",
              "value": "={{$json.followUp}}"
            },
            {
              "name": "customerData",
              "value": "={{$json}}"
            }
          ]
        },
        "options": {}
      },
      "id": "salvar-followup",
      "name": "Salvar Follow-up",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2000,
        200
      ]
    }
  ],
  "connections": {
    "Webhook WhatsApp": {
      "main": [
        [
          {
            "node": "Processar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Mensagem": {
      "main": [
        [
          {
            "node": "Verificar Handoff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Handoff": {
      "main": [
        [
          {
            "node": "Notificar Handoff",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Gerar Resposta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Resposta IA": {
      "main": [
        [
          {
            "node": "Enviar Resposta Z-API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Resposta Z-API": {
      "main": [
        [
          {
            "node": "Salvar Lead no Sistema",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notificar Handoff": {
      "main": [
        [
          {
            "node": "Enviar NotificaÃ§Ã£o Sistema",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar Lead no Sistema": {
      "main": [
        [
          {
            "node": "Verificar Interesse Comercial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Interesse Comercial": {
      "main": [
        [
          {
            "node": "Agendar Follow-up",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Agendar Follow-up": {
      "main": [
        [
          {
            "node": "Salvar Follow-up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "America/Sao_Paulo"
  },
  "versionId": "1",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "workflow-thermas-whatsapp",
  "tags": ["whatsapp", "automation", "thermas", "z-api"]
} 